/*! project-name v0.0.1 | (c) 2020 YOUR NAME | MIT License | http://link-to-your-git-repo.com */
const white="#EDEBEE",blackish="#262626",grey="#9A9CA0",greyDark="#616366",greyPale="#C2C3C7",colors_electro={plain:"#08C2B5",gradient_0:"#67FFF3",gradient_50:"#39E6DA",gradient_90:"#08C2B5",gradient_100:"#06A196"},colors_rock={plain:"#006891",gradient_0:"#61AECF",gradient_50:"#3A99C2",gradient_90:"#1C89B8",gradient_100:"#006891"},colors_hiphop={plain:"#BEF201",gradient_0:"#D5F57F",gradient_50:"#BEF201",gradient_90:"#ACE600",gradient_100:"#93C400"},colors_rb={plain:"#FFF845",gradient_0:"#FFF76B",gradient_50:"#FFF845",gradient_90:"#FFE433",gradient_100:"#FFC904"},colors_latin={plain:"#FF6301",gradient_0:"#FFBD94",gradient_50:"#FFA46B",gradient_90:"#FF8E45",gradient_100:"#FF6301"},colors_pop={plain:"#E498C8",gradient_0:"#E4AAD0",gradient_50:"#E498C8",gradient_90:"#E677BA",gradient_100:"#E652AE"},colors_dance={plain:"#DF3937",gradient_0:"#E67371",gradient_50:"#E04E4B",gradient_90:"#E62C29",gradient_100:"#E60501"},colors_blackGradient={gradient_0:"#585858",gradient_50:"#2D2D2D",gradient_90:"#0D0D0D",gradient_100:"#000000"},colors_whiteGradient={gradient_0:"#FFFFFF",gradient_50:white,gradient_90:"#0D0D0D",gradient_100:"#000000"},colors_greyGradient={gradient_0:"#FFFFFF",gradient_50:white,gradient_90:grey,gradient_100:greyDark},screenWidth=window.innerWidth,vizWidth=200,vizPerRow=screenWidth>=1600?8:Math.round((screenWidth-30)/200),vizHeight=330,circlesYCenter=120,infoYPosition=220;topSongs.forEach(t=>{t.acous=+t.acous,t.bpm=+t.bpm,t.dB=+t.dB,t.dnce=+t.dnce,t.dur=+t.dur,t.live=+t.live,t.nrgy=+t.nrgy,t.pop=+t.pop,t.rank=+t.rank,t.spch=+t.spch,t.streams_millions=+t.streams_millions,t.val=+t.val});const initializeDisplay=(t,a)=>{let r=d3.select("#visualization").selectAll("div").data(t).enter().append("div").attr("class","viz-container"),e=r.append("svg").attr("class",t=>"track track-"+t.rank).attr("width","100%").attr("height",330),n=e.append("g").attr("class","circles-container"),s=e.append("defs"),i=s.append("filter").attr("id",t=>"glow-"+t.rank);i.append("feGaussianBlur").attr("stdDeviation","3.5").attr("result","coloredBlur");let o=i.append("feMerge");o.append("feMergeNode").attr("in","coloredBlur"),o.append("feMergeNode").attr("in","SourceGraphic");let c=s.append("radialGradient").attr("id",t=>`radial-gradient-${t.genre_currated}`).attr("cx","50%").attr("cy","50%").attr("r","50%");c.append("stop").attr("offset","0%").attr("stop-color",t=>{switch(t.genre_currated){case"electro":return colors_electro.gradient_0;case"rock":return colors_rock.gradient_0;case"hip_hop":return colors_hiphop.gradient_0;case"r&b":return colors_rb.gradient_0;case"latin":return colors_latin.gradient_0;case"pop":return colors_pop.gradient_0;case"dance":return colors_dance.gradient_0;default:return white}}),c.append("stop").attr("offset","50%").attr("stop-color",t=>{switch(t.genre_currated){case"electro":return colors_electro.gradient_50;case"rock":return colors_rock.gradient_50;case"hip_hop":return colors_hiphop.gradient_50;case"r&b":return colors_rb.gradient_50;case"latin":return colors_latin.gradient_50;case"pop":return colors_pop.gradient_50;case"dance":return colors_dance.gradient_50;default:return white}}),c.append("stop").attr("offset","90%").attr("stop-color",t=>{switch(t.genre_currated){case"electro":return colors_electro.gradient_90;case"rock":return colors_rock.gradient_90;case"hip_hop":return colors_hiphop.gradient_90;case"r&b":return colors_rb.gradient_90;case"latin":return colors_latin.gradient_90;case"pop":return colors_pop.gradient_90;case"dance":return colors_dance.gradient_90;default:return white}}),c.append("stop").attr("offset","100%").attr("stop-color",t=>{switch(t.genre_currated){case"electro":return colors_electro.gradient_100;case"rock":return colors_rock.gradient_100;case"hip_hop":return colors_hiphop.gradient_100;case"r&b":return colors_rb.gradient_100;case"latin":return colors_latin.gradient_100;case"pop":return colors_pop.gradient_100;case"dance":return colors_dance.gradient_100;default:return white}});let d=s.append("radialGradient").attr("id","radial-gradient-black").attr("cx","50%").attr("cy","50%").attr("r","50%");d.append("stop").attr("offset","0%").attr("stop-color",colors_blackGradient.gradient_0),d.append("stop").attr("offset","50%").attr("stop-color",colors_blackGradient.gradient_50),d.append("stop").attr("offset","90%").attr("stop-color",colors_blackGradient.gradient_90),d.append("stop").attr("offset","100%").attr("stop-color",colors_blackGradient.gradient_100);let l=s.append("radialGradient").attr("id","radial-gradient-white").attr("cx","50%").attr("cy","50%").attr("r","50%");l.append("stop").attr("offset","0%").attr("stop-color",colors_whiteGradient.gradient_0),l.append("stop").attr("offset","50%").attr("stop-color",colors_whiteGradient.gradient_50),l.append("stop").attr("offset","90%").attr("stop-color",colors_whiteGradient.gradient_90),l.append("stop").attr("offset","100%").attr("stop-color",colors_whiteGradient.gradient_100);let p=s.append("radialGradient").attr("id","radial-gradient-grey").attr("cx","50%").attr("cy","50%").attr("r","50%");p.append("stop").attr("offset","0%").attr("stop-color",colors_greyGradient.gradient_0),p.append("stop").attr("offset","50%").attr("stop-color",colors_greyGradient.gradient_50),p.append("stop").attr("offset","90%").attr("stop-color",colors_greyGradient.gradient_90),p.append("stop").attr("offset","100%").attr("stop-color",colors_greyGradient.gradient_100);const g=d3.scaleLinear().domain(d3.extent(t,t=>t.streams_millions)).range([8,43]);n.append("circle").attr("id",t=>"stream-"+t.rank).attr("class","stream").attr("cx","50%").attr("cy",120).attr("r",t=>g(t.streams_millions)).style("fill",t=>{switch(t.genre_currated){case"electro":return"url(#radial-gradient-electro)";case"rock":return"url(#radial-gradient-rock)";case"hip_hop":return"url(#radial-gradient-hip_hop)";case"r&b":return"url(#radial-gradient-r&b)";case"latin":return"url(#radial-gradient-latin)";case"pop":return"url(#radial-gradient-pop)";case"dance":return"url(#radial-gradient-dance)";default:return white}}).style("filter",t=>`url(#glow-${t.rank})`);const u=d3.scaleLinear().domain(d3.extent(t,t=>t.dB)).range([0,5]);n.append("g").attr("id",t=>"loudness-"+t.rank).attr("class",t=>{const a=Math.ceil(getSizes("stream-"+t.rank).width/2);return((t,a,r)=>{for(let e=0;e<=a;e++)d3.select("#loudness-"+t).append("circle").attr("class","loudness").attr("cx","50%").attr("cy",120).attr("fill","none").attr("stroke",greyPale).attr("stroke-width",1).attr("stroke-opacity",.6).attr("r",r+5+3*e)})(t.rank,Math.ceil(u(t.dB)),a),"loudness-container"});const _=(t,a,r,e,n)=>{d3.select("#structure-"+a).append("circle").attr("class","structure structure-"+t).attr("cx","50%").attr("cy",120).attr("fill","none").attr("stroke",r).attr("stroke-width",e).attr("r",n)};n.append("g").attr("id",t=>"structure-"+t.rank).attr("class",t=>{const a=getSizes("loudness-"+t.rank).width/2;switch(t.sex_structure){case"women":_(t.sex_structure,t.rank,white,7,a+9);break;case"men":_(t.sex_structure,t.rank,white,2,a+9);break;case"collaboration":for(let r=0;r<2;r++)_(t.sex_structure,t.rank,white,2,a+6+6*r);break;case"band":for(let r=0;r<2;r++)_(t.sex_structure,t.rank,white,2,a+6+6*r);_(t.sex_structure,t.rank,white,1,a+9)}return"structure-container"});const h=t=>{return+a.find(a=>a.artist===t).count};n.append("circle").attr("class","appearances-arc").attr("cx","50%").attr("cy",120).attr("r",70).attr("fill","none").attr("stroke","none").attr("stroke-width",t=>{let a=1;const r=h(t.primary_artist_1);let e=0,n=0;""!==t.primary_artist_2&&(a+=1,e=h(t.primary_artist_2)),""!==t.primary_artist_3&&(a+=1,n=h(t.primary_artist_3));const s=r+e+n,i=getSizes("loudness-"+t.rank).width/2;return((t,a,r,e,n,s,i)=>{const o=degreesToRadians(360/r);let c="url(#radial-gradient-black)";const d=d3.select(`.track-${t} .circles-container`).append("g").attr("class","appearances-container");for(let t=1;t<=r;t++)t>e&&t<=e+n?c="url(#radial-gradient-white)":t>e+n&&(c="url(#radial-gradient-grey)"),d.append("circle").attr("class","appearance-circle").attr("cx",85+i*Math.sin(o*(t-1))).attr("cy",120-i*Math.cos(o*(t-1))).attr("r",3).attr("fill",c).attr("stroke","none")})(t.rank,0,s,r,e,0,i+9),1});const f=d3.arc().innerRadius(81).outerRadius(85).cornerRadius(3),m=d3.transition().ease(d3.easePolyOut.exponent(3)).duration(400),y=(t,a)=>{const r={startAngle:degreesToRadians(t),endAngle:degreesToRadians(t)},e={startAngle:degreesToRadians(t),endAngle:degreesToRadians(a)},n=d3.interpolate(r,e);return t=>f(n(t))},k=d3.scaleLinear().domain([0,360]).range([135,45]),x=e.append("g").attr("class","duration-arcs");x.append("path").attr("class","arc-bg arc-duration-bg").attr("fill",blackish).style("transform","translate(50%, 120px)").attr("d",t=>f({startAngle:degreesToRadians(135),endAngle:degreesToRadians(45)})),x.append("path").attr("class","arc-sup arc-duration-sup").attr("fill",white).style("transform","translate(50%, 120px)").transition(m).attrTween("d",t=>y(135,k(t.dur)));const b=d3.scaleLinear().domain([0,100]).range([-90,-45]),w=d3.scaleLinear().domain([0,100]).range([-90,-135]),F=e.append("g").attr("class","liveness-arcs");F.append("path").attr("class","arc-bg arc-liveness-bg").attr("fill",blackish).style("transform","translate(50%, 120px)").attr("d",t=>f({startAngle:degreesToRadians(-135),endAngle:degreesToRadians(-45)})),F.append("path").attr("class","arc-sup arc-liveness-sup").attr("fill",white).style("transform","translate(50%, 120px)").transition(m).attrTween("d",t=>y(-90,b(t.live))),F.append("path").attr("class","arc-sup arc-acousticness-sup").attr("fill",white).style("transform","translate(50%, 120px)").transition(m).attrTween("d",t=>y(-90,w(t.acous)));const v=d3.scaleLinear().domain([60,190]).range([0,10]),A=d3.scaleLinear().domain([0,100]).range([0,10]),R=d3.arc().cornerRadius(3),T=e.append("g").attr("class","top-arcs-container"),E=(t,a,r,e,n)=>{for(let s=0;s<r;s++){const r=s,i=e,o=n;d3.select("#"+t).append("path").attr("class",`top-arc top-arc-danceability ${a}${s+1}`).attr("fill",white).style("transform","translate(50%, 120px)").attr("d",t=>R({innerRadius:85+3*r,outerRadius:87+3*r,startAngle:i,endAngle:o}))}},M=(T.append("g").attr("id",t=>"top-arcs-bpm-"+t.rank).attr("class",t=>(E("top-arcs-bpm-"+t.rank,"arc-bpm-",Math.ceil(v(t.bpm)),degreesToRadians(-29),degreesToRadians(-18)),"top-arcs-section top-arcs-danceability")),T.append("g").attr("id",t=>"top-arcs-energy-"+t.rank).attr("class",t=>(E("top-arcs-energy-"+t.rank,"arc-energy-",Math.ceil(A(t.nrgy)),degreesToRadians(-17),degreesToRadians(-6)),"top-arcs-section top-arcs-danceability")),T.append("g").attr("id",t=>"top-arcs-danceability-"+t.rank).attr("class",t=>(E("top-arcs-danceability-"+t.rank,"arc-danceability-",Math.ceil(A(t.dnce)),degreesToRadians(-5),degreesToRadians(5)),"top-arcs-section top-arcs-danceability")),T.append("g").attr("id",t=>"top-arcs-valence-"+t.rank).attr("class",t=>(E("top-arcs-valence-"+t.rank,"arc-valence-",Math.ceil(A(t.val)),degreesToRadians(6),degreesToRadians(17)),"top-arcs-section top-arcs-danceability")),T.append("g").attr("id",t=>"top-arcs-speechness-"+t.rank).attr("class",t=>(E("top-arcs-speechness-"+t.rank,"arc-speechness-",Math.ceil(A(t.spch)),degreesToRadians(18),degreesToRadians(29)),"top-arcs-section top-arcs-danceability")),e.append("g").attr("class","track-info").append("g").attr("id",t=>"info-main-"+t.rank).attr("class","info-main"));M.append("text").attr("id",t=>"info-title-"+t.rank).attr("class","info-title").attr("x",85).attr("y",220).attr("dy",.2).attr("text-anchor","middle").text(t=>t.song).call(wrap,170),M.append("text").attr("id",t=>"info-artist-"+t.rank).attr("class","info-artist").attr("x",85).attr("y",t=>{return 220+Math.round(getSizes("info-title-"+t.rank).height)}).attr("dy",.3).attr("text-anchor","middle").text(t=>t.artist).call(wrap,170),M.append("text").attr("id",t=>"info-genre-year-"+t.rank).attr("class","info-genre-year").attr("x",85).attr("y",t=>{return 220+Math.round(getSizes("info-title-"+t.rank).height)+Math.round(getSizes("info-artist-"+t.rank).height)+10}).attr("dy",.3).attr("text-anchor","middle").text(t=>{const a=t.date_published.substring(0,4);return`${t.genre}, ${a}`}).call(wrap,170);const D=r.append("div").attr("id",t=>"info-sup-"+t.rank).attr("class","info-supplement").style("top",t=>{return`${Math.round(getSizes("info-main-"+t.rank).height)+225}px`}),B=D.append("div").attr("class","stream-number");B.append("span").attr("class","number").html(t=>`${t.streams_millions}M`),B.append("span").html(" streams");const G=D.append("div").attr("class","row"),C=G.append("div").attr("class","col-6").append("ul"),z=G.append("div").attr("class","col-6").append("ul"),$=C.append("li");$.append("span").attr("class","info-label").html("Duration: "),$.append("span").attr("class","info").html(t=>{return`${Math.floor(t.dur/60)}m${t.dur%60}s`});const S=C.append("li");S.append("span").attr("class","info-label").html("Liveness: "),S.append("span").attr("class","info").html(t=>t.live);const L=C.append("li");L.append("span").attr("class","info-label").html("Acousticness: "),L.append("span").attr("class","info").html(t=>t.acous);const Y=C.append("li");Y.append("span").attr("class","info-label").html("Loudness: "),Y.append("span").attr("class","info").html(t=>t.dB);const P=z.append("li");P.append("span").attr("class","info-label").html("Tempo: "),P.append("span").attr("class","info").html(t=>t.bpm);const W=z.append("li");W.append("span").attr("class","info-label").html("Energy: "),W.append("span").attr("class","info").html(t=>t.nrgy);const j=z.append("li");j.append("span").attr("class","info-label").html("Danceability: "),j.append("span").attr("class","info").html(t=>t.dnce);const H=z.append("li");H.append("span").attr("class","info-label").html("Valence: "),H.append("span").attr("class","info").html(t=>t.val);const I=z.append("li");I.append("span").attr("class","info-label").html("Speechness: "),I.append("span").attr("class","info").html(t=>t.spch);const N=D.append("div").attr("class","album");N.append("span").attr("class","info-label").html("album: "),N.append("span").attr("class","info").html(t=>t.album);const q=D.append("div").attr("class","num-appearance");q.append("span").attr("class","info").html(t=>`${t.primary_artist_1} appears `),q.append("span").attr("class","info-label").html(t=>{const a=h(t.primary_artist_1);return`${a} ${a>1?"times":"time"}`}),q.append("span").attr("class","info").html(" in this top 100."),e.on("mouseenter",t=>{const a=t.rank;d3.selectAll(".track").classed("hide",t=>t.rank!==a)}).on("mouseleave",t=>{d3.selectAll(".track").classed("hide",!1)});const O=g(3e3),V=d3.select(".legend-section-streams .legend-content").append("svg").attr("id","legend-streams"),J=V.append("g").attr("class","legend-streams-circles").attr("fill",white).attr("fill-opacity",.4).attr("stroke",white);J.append("circle").attr("r",O).attr("cx",O+1).attr("cy",O+1),J.append("circle").attr("r",g(2e3)).attr("cx",O+1).attr("cy",2*O-g(2e3)+1),J.append("circle").attr("r",g(1e3)).attr("cx",O+1).attr("cy",2*O-g(1e3)+1);const K=V.append("g").attr("class","legend-streams-lines").attr("stroke",white).attr("stroke-width",2).attr("stroke-dasharray","6 4");K.append("line").attr("x1",O+1).attr("x2",O+101).attr("y1",1).attr("y2",1),K.append("line").attr("x1",O+1).attr("x2",O+101).attr("y1",2*(O-g(2e3))+1).attr("y2",2*(O-g(2e3))+1),K.append("line").attr("x1",O+1).attr("x2",O+101).attr("y1",2*(O-g(1e3))+1).attr("y2",2*(O-g(1e3))+1);const Q=V.append("g").attr("class","legend-streams-text");Q.append("text").attr("x",O+104).attr("y",5).text("3000M"),Q.append("text").attr("x",O+104).attr("y",2*(O-g(2e3))+5).text("2000M"),Q.append("text").attr("x",O+104).attr("y",2*(O-g(1e3))+5).text("1000M")},degreesToRadians=t=>t*Math.PI/180,getSizes=t=>document.getElementById(t).getBBox(),wrap=(t,a)=>{t.each((function(){let t,r=d3.select(this),e=r.text().split(/\s+/).reverse(),n=[],s=0,i=r.attr("x"),o=r.attr("y"),c=parseFloat(r.attr("dy")),d=r.text(null).append("tspan").attr("x",i).attr("y",o).attr("dy",c+"em");for(;t=e.pop();)n.push(t),d.text(n.join(" ")),d.node().getComputedTextLength()>a&&(n.pop(),d.text(n.join(" ")),n=[t],d=r.append("tspan").attr("x",i).attr("y",o).attr("dy",1.1*++s+c+"em").text(t))}))};initializeDisplay(topSongs,artistsAppearances);const creationYear=2020,currentYear=(new Date).getFullYear(),copyrightYears=2020===currentYear?currentYear:`2020-${currentYear}`;document.querySelector(".copyright-years").innerHTML=copyrightYears;